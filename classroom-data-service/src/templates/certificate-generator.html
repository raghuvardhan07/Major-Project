<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Classroom Environment Certificate Generator</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --primary: #3f51b5;
                --primary-light: #5c6bc0;
                --primary-dark: #303f9f;
                --secondary: #4caf50;
                --secondary-light: #66bb6a;
                --secondary-dark: #388e3c;
                --danger: #f44336;
                --gray-light: #f5f5f5;
                --gray: #e0e0e0;
                --gray-dark: #757575;
                --text: #333333;
                --white: #ffffff;
                --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                --border-radius: 8px;
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                font-family: "Roboto", sans-serif;
                background-color: #f9f9f9;
                color: var(--text);
                line-height: 1.6;
            }

            .container {
                max-width: 800px;
                margin: 40px auto;
                padding: 0 20px;
            }

            .header {
                text-align: center;
                margin-bottom: 40px;
            }

            .header h1 {
                color: var(--primary);
                font-size: 32px;
                margin-bottom: 10px;
            }

            .header p {
                color: var(--gray-dark);
                font-size: 16px;
            }

            .card {
                background-color: var(--white);
                border-radius: var(--border-radius);
                box-shadow: var(--shadow);
                padding: 30px;
                margin-bottom: 30px;
                position: relative;
            }

            .form-group {
                margin-bottom: 25px;
            }

            .form-group:last-child {
                margin-bottom: 0;
            }

            label {
                display: block;
                margin-bottom: 8px;
                font-weight: 500;
                color: var(--primary-dark);
            }

            select,
            input[type="date"] {
                width: 100%;
                padding: 12px 15px;
                border: 1px solid var(--gray);
                border-radius: var(--border-radius);
                font-size: 16px;
                transition: border-color 0.3s, box-shadow 0.3s;
            }

            select:focus,
            input[type="date"]:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
            }

            .btn-container {
                display: flex;
                justify-content: center;
                gap: 15px;
                margin-top: 20px;
            }

            .btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 12px 25px;
                border-radius: var(--border-radius);
                font-size: 16px;
                font-weight: 500;
                cursor: pointer;
                transition: background-color 0.3s, transform 0.1s;
                border: none;
                text-decoration: none;
                gap: 10px;
            }

            .btn:hover {
                transform: translateY(-2px);
            }

            .btn:active {
                transform: translateY(0);
            }

            .btn-primary {
                background-color: var(--primary);
                color: var(--white);
            }

            .btn-primary:hover {
                background-color: var(--primary-dark);
            }

            .btn-secondary {
                background-color: var(--secondary);
                color: var(--white);
            }

            .btn-secondary:hover {
                background-color: var(--secondary-dark);
            }

            .btn-outline {
                background-color: transparent;
                border: 2px solid var(--primary);
                color: var(--primary);
            }

            .btn-outline:hover {
                background-color: rgba(63, 81, 181, 0.1);
            }

            .features {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 20px;
                margin-top: 40px;
            }

            .feature-card {
                padding: 20px;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow);
                background-color: var(--white);
                transition: transform 0.3s;
            }

            .feature-card:hover {
                transform: translateY(-5px);
            }

            .feature-icon {
                font-size: 36px;
                margin-bottom: 15px;
                color: var(--primary);
            }

            .feature-title {
                font-size: 18px;
                font-weight: 500;
                margin-bottom: 10px;
            }

            .feature-description {
                color: var(--gray-dark);
                font-size: 14px;
            }

            .icon {
                display: inline-block;
                width: 24px;
                height: 24px;
                stroke-width: 0;
                stroke: currentColor;
                fill: currentColor;
            }

            footer {
                text-align: center;
                margin-top: 60px;
                padding: 20px;
                color: var(--gray-dark);
                font-size: 14px;
            }

            .recent-certificates {
                margin-top: 40px;
            }

            .recent-certificates h2 {
                margin-bottom: 20px;
                color: var(--primary-dark);
                font-size: 24px;
            }

            .certificate-list {
                list-style: none;
            }

            .certificate-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                border-bottom: 1px solid var(--gray);
                transition: background-color 0.3s;
            }

            .certificate-item:hover {
                background-color: var(--gray-light);
            }

            .certificate-item:first-child {
                border-top: 1px solid var(--gray);
            }

            .certificate-info {
                flex: 1;
            }

            .certificate-name {
                font-weight: 500;
                margin-bottom: 5px;
            }

            .certificate-date {
                font-size: 14px;
                color: var(--gray-dark);
            }

            .certificate-grade {
                display: inline-block;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                background-color: var(--secondary);
                color: var(--white);
                text-align: center;
                line-height: 30px;
                font-weight: 700;
                margin-right: 15px;
            }

            .grade-a-plus,
            .grade-a {
                background-color: #4caf50;
            }

            .grade-b {
                background-color: #8bc34a;
            }

            .grade-c {
                background-color: #ffc107;
            }

            .grade-d {
                background-color: #ff9800;
            }

            .grade-f {
                background-color: #f44336;
            }

            .certificate-actions {
                display: flex;
                gap: 10px;
            }

            .btn-icon {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: var(--gray-light);
                color: var(--gray-dark);
                transition: background-color 0.3s, color 0.3s;
            }

            .btn-icon:hover {
                background-color: var(--primary);
                color: var(--white);
            }

            .loading {
                text-align: center;
                padding: 20px;
                color: var(--gray-dark);
            }

            .no-certificates {
                text-align: center;
                padding: 20px;
                color: var(--gray-dark);
                font-style: italic;
            }

            .success-message,
            .error-message {
                padding: 12px;
                border-radius: var(--border-radius);
                margin-bottom: 20px;
                display: none;
            }

            .success-message {
                background-color: rgba(76, 175, 80, 0.1);
                color: #388e3c;
                border: 1px solid rgba(76, 175, 80, 0.3);
            }

            .error-message {
                background-color: rgba(244, 67, 54, 0.1);
                color: #d32f2f;
                border: 1px solid rgba(244, 67, 54, 0.3);
            }

            /* Loading overlay styles */
            .loading-overlay {
                display: none;
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(255, 255, 255, 0.9);
                border-radius: var(--border-radius);
                z-index: 10;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                padding: 20px;
                text-align: center;
            }

            .loading-overlay.active {
                display: flex;
            }

            .spinner {
                width: 40px;
                height: 40px;
                border: 4px solid rgba(63, 81, 181, 0.2);
                border-radius: 50%;
                border-top-color: var(--primary);
                animation: spin 1s ease-in-out infinite;
                margin-bottom: 15px;
            }

            .loading-message {
                font-size: 16px;
                font-weight: 500;
                color: var(--primary-dark);
                margin-bottom: 10px;
            }

            .loading-details {
                font-size: 14px;
                color: var(--gray-dark);
                max-width: 300px;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Classroom Environment Certificate Generator</h1>
                <p>
                    Generate environmental quality certificates based on historical classroom data
                </p>
            </div>

            <div id="success-message" class="success-message"></div>
            <div id="error-message" class="error-message"></div>

            <div class="card">
                <!-- Loading overlay -->
                <div id="loading-overlay" class="loading-overlay">
                    <div class="spinner"></div>
                    <div class="loading-message">Generating Certificate...</div>
                    <div class="loading-details">
                        This may take a while if we need to fetch data from ThingSpeak. Please don't
                        close this window.
                    </div>
                </div>

                <form id="certificate-form" action="/generate-certificate" method="post">
                    <div class="form-group">
                        <label for="classroom">Select Classroom</label>
                        <select id="classroom" name="classroom" required>
                            <option value="">Select a classroom</option>
                            <option value="classroom1">Classroom 1</option>
                            <option value="classroom2">Classroom 2</option>
                            <option value="all">All Classrooms</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="start-date">Start Date</label>
                        <input type="date" id="start-date" name="startDate" required />
                    </div>

                    <div class="form-group">
                        <label for="end-date">End Date</label>
                        <input type="date" id="end-date" name="endDate" required />
                    </div>

                    <div class="btn-container">
                        <button type="submit" class="btn btn-primary">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path
                                    d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"
                                ></path>
                            </svg>
                            Generate Certificate
                        </button>
                        <button type="reset" class="btn btn-outline">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"
                                ></path>
                            </svg>
                            Reset
                        </button>
                    </div>
                </form>
            </div>

            <div class="features">
                <div class="feature-card">
                    <div class="feature-icon">📊</div>
                    <h3 class="feature-title">Data Analysis</h3>
                    <p class="feature-description">
                        Analyze environmental data collected from multiple sensors in the classroom.
                    </p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">📋</div>
                    <h3 class="feature-title">Quality Grading</h3>
                    <p class="feature-description">
                        Get a quality grade based on KPIv values using a sigmoid scoring function.
                    </p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">🔍</div>
                    <h3 class="feature-title">Detailed Metrics</h3>
                    <p class="feature-description">
                        View temperature, humidity, CO2 levels, and occupancy metrics.
                    </p>
                </div>
            </div>

            <div class="recent-certificates">
                <h2>Recent Certificates</h2>
                <ul class="certificate-list" id="recent-certificates">
                    <li class="loading">Loading recent certificates...</li>
                </ul>
            </div>
        </div>

        <footer>
            <p>Classroom Monitoring System &copy; 2023 | Environmental Data Analytics</p>
        </footer>

        <script>
            // Set default dates (last 30 days)
            document.addEventListener("DOMContentLoaded", function () {
                const today = new Date();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(today.getDate() - 30);

                // Format dates as YYYY-MM-DD
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, "0");
                    const day = String(date.getDate()).padStart(2, "0");
                    return `${year}-${month}-${day}`;
                };

                document.getElementById("start-date").value = formatDate(thirtyDaysAgo);
                document.getElementById("end-date").value = formatDate(today);

                // Check for URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const errorMessage = urlParams.get("error");
                const successMessage = urlParams.get("success");

                if (errorMessage) {
                    showMessage("error", decodeURIComponent(errorMessage));
                }

                if (successMessage) {
                    showMessage("success", decodeURIComponent(successMessage));
                }

                // Form submission will show loading overlay
                document.getElementById("certificate-form").addEventListener("submit", function () {
                    // Show loading overlay
                    document.getElementById("loading-overlay").classList.add("active");

                    // Update message based on selected classroom
                    const classroom = document.getElementById("classroom").value;
                    const loadingMessage = document.querySelector(".loading-message");
                    if (classroom === "all") {
                        loadingMessage.textContent =
                            "Generating Certificates for All Classrooms...";
                    } else {
                        loadingMessage.textContent = `Generating Certificate for ${classroom.replace(
                            "classroom",
                            "Classroom "
                        )}...`;
                    }

                    // Disable the submit button to prevent multiple submissions
                    const submitBtn = this.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                });

                // Reset button should clear error messages
                document
                    .querySelector('button[type="reset"]')
                    .addEventListener("click", function () {
                        document.getElementById("error-message").style.display = "none";
                        document.getElementById("success-message").style.display = "none";
                    });

                // Initialize date validation
                const startDateInput = document.getElementById("start-date");
                const endDateInput = document.getElementById("end-date");

                // Ensure end date is not before start date
                endDateInput.addEventListener("change", function () {
                    if (startDateInput.value && this.value && this.value < startDateInput.value) {
                        showMessage("error", "End date cannot be before start date");
                        this.value = startDateInput.value;
                    }
                });

                // Ensure start date is not after end date
                startDateInput.addEventListener("change", function () {
                    if (endDateInput.value && this.value && this.value > endDateInput.value) {
                        showMessage("error", "Start date cannot be after end date");
                        this.value = endDateInput.value;
                    }
                });

                // Fetch recent certificates
                fetchRecentCertificates();
            });

            // Function to display messages
            function showMessage(type, message) {
                const element = document.getElementById(`${type}-message`);
                element.textContent = message;
                element.style.display = "block";

                // Hide message after 8 seconds
                setTimeout(() => {
                    element.style.display = "none";
                }, 8000);
            }

            // Function to fetch recent certificates from the API
            function fetchRecentCertificates() {
                fetch("/api/recent-certificates")
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error("Failed to fetch recent certificates");
                        }
                        return response.json();
                    })
                    .then((certificates) => {
                        const container = document.getElementById("recent-certificates");
                        container.innerHTML = ""; // Clear loading message

                        if (certificates.length === 0) {
                            container.innerHTML =
                                '<li class="no-certificates">No certificates generated yet. Generate your first certificate above!</li>';
                            return;
                        }

                        // Create list items for each certificate
                        certificates.forEach((cert) => {
                            // Determine grade class
                            let gradeClass = "";
                            if (cert.grade === "A+" || cert.grade === "A") {
                                gradeClass = "grade-a";
                            } else if (cert.grade === "B") {
                                gradeClass = "grade-b";
                            } else if (cert.grade === "C") {
                                gradeClass = "grade-c";
                            } else if (cert.grade === "D") {
                                gradeClass = "grade-d";
                            } else if (cert.grade === "F") {
                                gradeClass = "grade-f";
                            }

                            // Format the displayed classroom name
                            const displayClassroomName = cert.classroomId.replace(
                                "classroom",
                                "Classroom "
                            );

                            const listItem = document.createElement("li");
                            listItem.className = "certificate-item";
                            listItem.innerHTML = `
                                <div class="certificate-grade ${gradeClass}">${cert.grade}</div>
                                <div class="certificate-info">
                                    <div class="certificate-name">${displayClassroomName}</div>
                                    <div class="certificate-date">${cert.period.startDate} - ${cert.period.endDate}</div>
                                </div>
                                <div class="certificate-actions">
                                    <a href="/${cert.htmlFilename}" class="btn-icon" title="View Certificate">
                                        <svg class="icon" viewBox="0 0 24 24">
                                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path>
                                        </svg>
                                    </a>
                                </div>
                            `;

                            container.appendChild(listItem);
                        });
                    })
                    .catch((error) => {
                        console.error("Error fetching certificates:", error);
                        const container = document.getElementById("recent-certificates");
                        container.innerHTML =
                            '<li class="no-certificates">Failed to load recent certificates. Please try again later.</li>';
                    });
            }
        </script>
    </body>
</html>
